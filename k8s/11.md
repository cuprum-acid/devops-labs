# Kubernetes Secrets and Hashicorp Vault

## Task 1: Kubernetes Secrets and Resource Management

### Create a Secret

Use `kubectl create secret`:

```bash
kubectl create secret generic my-secret --from-literal=username=username --from-literal=password=password
```

Example:

```bash
ebob@laptop devops-labs % kubectl create secret generic eugengold-secret --from-literal=username=eugengold --from-literal=password=amogus123
secret/eugengold-secret created
```

### Verify the Secret

```bash
kubectl get secrets
```

Example:

```bash
ebob@laptop devops-labs % kubectl get secrets
NAME                                    TYPE     DATA   AGE
eugengold-secret                        Opaque   2      91s
nginx-ingress-ingress-nginx-admission   Opaque   3      4d22h
```

View details:

```bash
kubectl describe secret eugengold-secret
```

Example:

```bash
ebob@laptop devops-labs % kubectl describe secret eugengold-secret
Name:         eugengold-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
username:  9 bytes
password:  9 bytes
```

### Decode the Secret

Kubernetes stores secret data in Base64 encoding. To decode it, use:

```bash
kubectl get secret eugengold-secret -o jsonpath="{.data.username}" | base64 --decode
echo
kubectl get secret eugengold-secret -o jsonpath="{.data.password}" | base64 --decode
echo
```

Example:

```bash
ebob@laptop devops-labs % kubectl get secret eugengold-secret -o jsonpath="{.data.username}" | base64 --decode
echo
kubectl get secret eugengold-secret -o jsonpath="{.data.password}" | base64 --decode
echo
eugengold
amogus123
```

### Manage Secrets with Helm

I followed steps from the [video](https://www.youtube.com/watch?v=hRSlKRvYe1A) and used GPG key to encode my secret. I can store it directly in the repository.

Installation of the chart is performed via `helm secrets install moscow-time ./moscow-time -n default -f ./moscow-time/secrets.yaml`:

```bash
ebob@laptop k8s % helm secrets install moscow-time ./moscow-time -n default -f ./moscow-time/secrets.yaml
[helm-secrets] Decrypt: ./moscow-time/secrets.yaml
NAME: moscow-time
LAST DEPLOYED: Wed Mar  5 00:16:20 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
[helm-secrets] Removed: ./moscow-time/secrets.yaml.dec
ebob@laptop k8s % helm ls
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
moscow-time     default         1               2025-03-05 00:16:20.928616 +0300 MSK    deployed        moscow-time-0.1.0       1.1
```

```bash
ebob@laptop k8s % kubectl get po
NAME                           READY   STATUS    RESTARTS   AGE
moscow-time-67946d5f79-2xbh4   1/1     Running   0          27m
moscow-time-67946d5f79-bk9zb   1/1     Running   0          27m
moscow-time-67946d5f79-kr9wl   1/1     Running   0          27m
ebob@laptop k8s % kubectl exec moscow-time-67946d5f79-2xbh4 -- printenv | grep MY_PASS
MY_PASS=amogus123
```

## Task 2: Vault Secret Management System

### Install Vault Using Helm Chart:

```bash
ebob@laptop k8s % helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories
```

```bash
ebob@laptop k8s % helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
...Successfully got an update from the "ingress-nginx" chart repository
...Successfully got an update from the "external-secrets" chart repository
...Successfully got an update from the "prometheus-community" chart repository
...Successfully got an update from the "grafana" chart repository
Update Complete. ⎈Happy Helming!⎈
```

```bash
ebob@laptop k8s % helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Wed Mar  5 00:54:06 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs


Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

```bash
ebob@laptop k8s % kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
moscow-time-67946d5f79-2xbh4            1/1     Running   0          46m
moscow-time-67946d5f79-bk9zb            1/1     Running   0          46m
moscow-time-67946d5f79-kr9wl            1/1     Running   0          46m
vault-0                                 1/1     Running   0          9m3s
vault-agent-injector-66f45b5fd5-hnvjp   1/1     Running   0          9m4s
```

### Set a secret in Vault

Follow [Vault Installation Guide](https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-sidecar#install-the-vault-helm-chart):

```bash
ebob@laptop k8s % kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-04T22:09:50.090774888Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-03-04T22:09:50.090774888Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

Follow guide, patch deployment:

```bash
kubectl patch deployment moscow-time --patch-file=patch.yaml
```

Verify result:

```bash
ebob@laptop moscow-time % kubectl exec -it moscow-time-5c56f64c59-47kdr -- sh
Defaulted container "moscow-time" out of: moscow-time, vault-agent, vault-agent-init (init)
/app $ ls
app.py            requirements.txt
/app $ cd ..
/ $ ls
app    bin    dev    etc    home   lib    media  mnt    opt    proc   root   run    sbin   srv    sys    tmp    usr    var    vault
/ $ cd vault/secrets/
/vault/secrets $ ls
database-config.txt
/vault/secrets $ cat database-config.txt
postgresql://db-readonly-username:db-secret-password@postgres:5432/wizard/vault/secrets $
/vault/secrets $ df -h
Filesystem                Size      Used Available Use% Mounted on
overlay                  58.4G     48.5G      6.9G  88% /
tmpfs                    64.0M         0     64.0M   0% /dev
shm                      64.0M         0     64.0M   0% /dev/shm
tmpfs                     3.8G      4.0K      3.8G   0% /vault/secrets
/dev/vda1                58.4G     48.5G      6.9G  88% /dev/termination-log
/dev/vda1                58.4G     48.5G      6.9G  88% /etc/resolv.conf
/dev/vda1                58.4G     48.5G      6.9G  88% /etc/hostname
/dev/vda1                58.4G     48.5G      6.9G  88% /etc/hosts
tmpfs                     3.8G     12.0K      3.8G   0% /run/secrets/kubernetes.io/serviceaccount
tmpfs                    64.0M         0     64.0M   0% /proc/kcore
tmpfs                    64.0M         0     64.0M   0% /proc/keys
tmpfs                    64.0M         0     64.0M   0% /proc/timer_list
tmpfs                     1.9G         0      1.9G   0% /proc/scsi
tmpfs                     1.9G         0      1.9G   0% /sys/firmware
```

## Resources

Resources are configured in `values.yaml`

App after apply changs:

```bash
ebob@laptop moscow-time % kubectl describe deployments.apps moscow-time
Name:                   moscow-time
Namespace:              default
CreationTimestamp:      Wed, 05 Mar 2025 00:16:50 +0300
Labels:                 app.kubernetes.io/instance=moscow-time
                        app.kubernetes.io/managed-by=Helm
                        app.kubernetes.io/name=moscow-time
                        app.kubernetes.io/version=1.1
                        helm.sh/chart=moscow-time-0.1.0
Annotations:            deployment.kubernetes.io/revision: 4
                        meta.helm.sh/release-name: moscow-time
                        meta.helm.sh/release-namespace: default
Selector:               app.kubernetes.io/instance=moscow-time,app.kubernetes.io/name=moscow-time
Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:           app.kubernetes.io/instance=moscow-time
                    app.kubernetes.io/name=moscow-time
  Annotations:      vault.hashicorp.com/agent-inject: true
                    vault.hashicorp.com/agent-inject-secret-database-config.txt: internal/data/database/config
                    vault.hashicorp.com/agent-inject-status: update
                    vault.hashicorp.com/agent-inject-template-database-config.txt:
                      {{- with secret "internal/data/database/config" -}}
                      postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard
                      {{- end -}}
                    vault.hashicorp.com/role: internal-app
  Service Account:  internal-app
  Containers:
   moscow-time:
    Image:      ebob/moscow-time:v1.1
    Port:       80/TCP
    Host Port:  0/TCP
    Environment:
      ENVIRONMENT:  stage
    Mounts:         <none>
  Volumes:          <none>
  Node-Selectors:   <none>
  Tolerations:      <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  moscow-time-67946d5f79 (0/0 replicas created), moscow-time-8db9dcb6c (0/0 replicas created), moscow-time-5c56f64c59 (0/0 replicas created)
NewReplicaSet:   moscow-time-58dc48f497 (3/3 replicas created)
Events:
  Type    Reason             Age                From                   Message
  ----    ------             ----               ----                   -------
  Normal  ScalingReplicaSet  52m                deployment-controller  Scaled up replica set moscow-time-8db9dcb6c from 0 to 1
```

## Environmental variables

```bash
ebob@laptop moscow-time % kubectl exec -it moscow-time-58dc48f497-4h2bz  -- env
Defaulted container "moscow-time" out of: moscow-time, vault-agent, vault-agent-init (init)
PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=moscow-time-58dc48f497-4h2bz
TERM=xterm
ENVIRONMENT=stage
KUBERNETES_PORT_443_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
MOSCOW_TIME_SERVICE_HOST=10.99.90.244
VAULT_PORT_8200_TCP_PROTO=tcp
VAULT_PORT_8200_TCP_ADDR=10.98.88.189
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT=443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PROTO=tcp
KUBERNETES_SERVICE_PORT=443
VAULT_SERVICE_HOST=10.98.88.189
VAULT_SERVICE_PORT=8200
VAULT_PORT_8201_TCP_PROTO=tcp
VAULT_PORT_8201_TCP_ADDR=10.98.88.189
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_PORT=443
KUBERNETES_SERVICE_HOST=10.96.0.1
KUBERNETES_PORT_443_TCP_PORT=443
MOSCOW_TIME_SERVICE_PORT_HTTP=80
VAULT_SERVICE_PORT_HTTPS_INTERNAL=8201
VAULT_PORT_8200_TCP_PORT=8200
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT=tcp://10.96.0.1:443
MOSCOW_TIME_SERVICE_PORT=80
MOSCOW_TIME_PORT=tcp://10.99.90.244:80
VAULT_PORT_8201_TCP=tcp://10.98.88.189:8201
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP=tcp://10.102.73.9:443
VAULT_SERVICE_PORT_HTTP=8200
VAULT_PORT=tcp://10.98.88.189:8200
MOSCOW_TIME_PORT_80_TCP_ADDR=10.99.90.244
VAULT_PORT_8201_TCP_PORT=8201
VAULT_AGENT_INJECTOR_SVC_PORT=tcp://10.102.73.9:443
VAULT_AGENT_INJECTOR_SVC_PORT_443_TCP_ADDR=10.102.73.9
MOSCOW_TIME_PORT_80_TCP_PORT=80
VAULT_AGENT_INJECTOR_SVC_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
MOSCOW_TIME_PORT_80_TCP_PROTO=tcp
VAULT_AGENT_INJECTOR_SVC_SERVICE_HOST=10.102.73.9
MOSCOW_TIME_PORT_80_TCP=tcp://10.99.90.244:80
VAULT_PORT_8200_TCP=tcp://10.98.88.189:8200
GPG_KEY=7169605F62C751356D054A26A821E680E5FA6305
PYTHON_VERSION=3.13.1
PYTHON_SHA256=9cf9427bee9e2242e3877dd0f6b641c1853ca461f39d6503ce260a59c80bf0d9
PYTHONDONTWRITEBYTECODE=1
PYTHONUNBUFFERED=1
HOME=/home/appuser
```
